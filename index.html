<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>WooHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js" defer></script>
  <style>
    #passcode-overlay .box{background:#fff;padding:2rem;border-radius:.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.2);max-width:320px;width:90%;text-align:center;display:flex;flex-direction:column;gap:1rem;}
    #passcode-overlay input{width:100%;}
    #passcode-overlay button{width:100%;}
    #passcode-overlay {backdrop-filter: blur(5px);}
    #passcode-error {display: none;}
    @keyframes bell-bounce{0%,100%{transform:rotate(0)}25%{transform:rotate(10deg)}75%{transform:rotate(-10deg)}}
    @keyframes gradient-slide{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .suggestion-enter{transform:translateX(-20px);opacity:0}
    .suggestion-enter-active{animation:slide-in .3s forwards}
    @keyframes slide-in{to{transform:translateX(0);opacity:1}}
    @keyframes slide-down{from{transform:translateY(-100%)}to{transform:translateY(0)}}
    #update-banner.show{animation:slide-down .3s ease-out forwards}
    #update-banner {position: fixed; top: 4rem; left: 0; right: 0; z-index: 10; width: 100%;}
    #overlay ol{list-style:decimal}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased flex flex-col min-h-screen">
  <div id="passcode-overlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:9999;">
 <div class="box">
  <img src="assets/woohub_logo.png" alt="Logo" class="mx-auto mb-4 h-12"/>
  <h2 class="text-xl font-semibold">Enter Passcode</h2>
    <input type="password" id="passcode-input" placeholder="Your passcode‚Ä¶" />
    <button id="passcode-submit">Unlock</button>
    <p id="passcode-error">Incorrect passcode.</p></div></div>
  <div id="parallax-bg" class="fixed inset-0 bg-[url('/assets/pattern.svg')] bg-center bg-cover pointer-events-none"></div>
  <noscript><div class="p-4 bg-yellow-100 text-yellow-800">JavaScript is required to use WooHub.</div></noscript>
  <header class="relative bg-white shadow sticky top-0 z-20 flex items-center justify-between h-16 px-4 lg:px-8">
    <a href="#" onclick="event.preventDefault()" class="h-16 flex items-center">
      <img src="assets/woohub_logo.png" alt="Logo" class="h-10"/>
    </a>
    <div class="absolute left-1/2 transform -translate-x-1/2 w-full max-w-lg">
      <input id="search-input" type="search" placeholder="Search keywords..."
             aria-autocomplete="list" aria-controls="search-suggestions"
             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none focus:ring-indigo-500"/>
      <ul id="search-suggestions"
          class="hidden absolute left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-auto z-30"></ul>
    </div>
    <div class="flex items-center">
      <div class="relative">
        <button id="notification-btn" class="p-2">
          <svg id="bellIcon" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
          <span id="notification-count"
                class="hidden absolute -top-1 -right-1 inline-flex items-center justify-center px-1 text-xs font-bold text-white bg-red-600 rounded-full"></span>
        </button>
        <div id="notification-dropdown"
             class="hidden absolute right-0 mt-2 w-96 p-4 bg-white border rounded-lg shadow-lg z-40">
          <ul id="notification-list" class="max-h-64 overflow-y-auto divide-y divide-gray-200"></ul>
        </div>
      </div>
      <div class="relative ml-4">
        <button id="recent-btn" class="p-2">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </button>
        <div id="recent-dropdown"
             class="hidden absolute right-0 mt-2 w-72 p-4 bg-white border rounded-lg shadow-lg z-40">
          <ul id="recent-list" class="max-h-60 overflow-y-auto divide-y divide-gray-200"></ul>
        </div>
      </div>
    </div>
  </header>

  <div id="update-banner" class="hidden bg-indigo-600 text-white flex items-center justify-center px-6 py-3 relative">
    <div id="update-banner-content" class="flex-1 text-sm font-medium text-center"></div>
    <button id="update-banner-close" class="absolute right-4 text-xl font-bold focus:outline-none">&times;</button>
  </div>

  <details class="lg:hidden px-4 mt-2">
    <summary class="flex justify-between font-semibold cursor-pointer"><span>Recent Updates</span><button id="mobile-updates-filter-toggle" class="p-1 focus:outline-none"></button></summary>
    <div class="mt-2 space-y-2"><div id="mobile-updates-filter-container" class="hidden"><input id="mobile-updates-filter" type="text" placeholder="Filter updates..."class="w-full px-3 py-1 mb-2 border rounded-lg focus:ring-1 focus:outline-none focus:ring-indigo-500"/></div>
    <ul id="mobile-updates-container" class="max-h-60 overflow-y-auto space-y-2 pr-2"></ul><button id="mobile-load-more-btn" class="w-full mt-2 text-indigo-600 hover:underline">Load More</button></div>
  </details>
  
<div class="flex flex-1 w-full max-w-[2000px] mx-auto px-4 pt-6 pb-0">
<aside class="hidden lg:block w-80 lg:w-96 mr-6 pb-6">
  <div class="bg-white border rounded-lg p-4 sticky top-24 h-[calc(100vh-10rem)] overflow-y-auto">
    <!-- Tab Headers -->
    <div class="flex mb-4 border-b">
      <button
        id="tab-recent"
        class="flex-1 py-2 text-center font-semibold border-b-2 border-indigo-600 text-gray-900">
        Announcements
      </button>
      <button
        id="tab-whatsnew"
        class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
        Release Notes
      </button>
    </div>

    <!-- Recent Updates Panel -->
    <div id="panel-recent" class="space-y-2">
      <div class="flex justify-between mb-2">
        <h2 class="font-semibold text-lg">Recent Updates</h2>
        <button id="updates-filter-toggle" class="p-1 text-gray-600 hover:text-gray-800">
          <!-- filter icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414a1
                          1 0 00-.293.707V19l-4-2v-4.172a1 1 0 00-.293-.707L3.293 6.707A1 1 0
                          013 6V4z" />
          </svg>
        </button>
      </div>
      <div id="updates-filter-container" class="hidden mb-2">
        <input id="updates-filter" type="text"
               placeholder="Filter updates..."
               class="w-full p-2 border rounded" />
      </div>
      <ul id="updates-container" class="space-y-2"></ul>
    </div>

    <!-- What's New Panel -->
    <div id="panel-whatsnew" class="hidden space-y-2">
      <div class="flex justify-between mb-2">
        <h2 class="font-semibold text-lg">What‚Äôs New and Different?</h2>
        <button id="changelog-filter-toggle" class="p-1 text-gray-600 hover:text-gray-800">
          <!-- filter icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V19l-4-2v-4.172a1 1 0 00-.293-.707L3.293 6.707A1 1 0 013 6V4z" />
          </svg>
        </button>
      </div>
      <div id="changelog-filter-container" class="hidden mb-2">
        <input id="changelog-filter" type="text"
               placeholder="Filter changes..."
               class="w-full p-2 border rounded" /></div>
      <ul id="change-log" class="space-y-2"></ul></div>
  </div>
</aside>

  <main class="relative flex-1 flex flex-col">
    <nav class="text-sm mb-4">
      <ol class="flex text-gray-600">
        <li><a href="#" onclick="event.preventDefault()" class="hover:underline">Home</a></li>
        <li><span class="mx-2">/</span></li>
        <li>Dashboard</li>
      </ol>
    </nav>
    
    <section id="detail-container"
             class="hidden absolute inset-0 bg-white rounded-lg shadow p-6 flex flex-col"
             style="height:calc(100% - 1rem);max-height:calc(100vh - 1rem);overflow-y:auto;margin-bottom:1rem;">
      <button id="back-btn"
              class="self-start mb-4 font-medium text-indigo-600 hover:underline focus:outline-none">
        ‚Üê Back to Dashboard
      </button>
      <h2 id="detail-title" class="text-2xl font-semibold mb-4"></h2>
      <ul id="detail-list" class="flex-1 overflow-y-auto list-disc pl-5 space-y-2"></ul>
    </section>

    <section id="card-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"></section>
  </main>
</div>

<div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 items-start justify-center overflow-y-auto z-40">
  <div class="relative mt-20 mx-auto w-11/12 md:w-3/4 lg:w-1/2 max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-lg p-6" tabindex="-1">
    <button id="overlay-close" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-700">&times;</button>
    <button id="copy-btn" class="absolute top-4 right-12 text-sm text-gray-500 hover:text-gray-700 hidden">Copy</button>
    <h2 id="overlay-header" class="text-2xl font-semibold mb-4"></h2>
    <div id="overlay-body" class="space-y-4" tabindex="0"></div>
  </div>
</div>

<button id="to-top" class="hidden fixed bottom-6 right-6 p-3 bg-indigo-600 text-white rounded-full shadow-lg">‚Üë</button>

<footer class="bg-white border-t">
  <div class="flex justify-between items-center h-[2.5rem] px-4">
    <p class="text-sm text-gray-500">&copy; 2025 WooHub. All rights reserved.</p>
    <p class="text-sm text-gray-500">Developed By: Christine Anastacio</p>
  </div>
</footer>
<script>
  
  const SHEET_ID = '1cfLvub1zli1txycgl1TZxKr_oUMvqUrhkRwkJ6UG5hw';
  function fetchSheet(tab) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`
            + `?sheet=${encodeURIComponent(tab)}&tqx=out:json`;
  return fetch(url)
    .then(r => r.text())
    .then(text => {
      const table = JSON.parse(text.substr(47).slice(0, -2)).table;
      return table.rows.map(rw => {
        const [c0, c1, c2] = rw.c.map(cell => cell && cell.v);
        if (tab === 'notifications') return { time: c0, text: c1 };
        if (tab === 'Announcements' || tab === 'Release Notes') {return { time: c0, text: c1 };}
        if (tab === 'links') {return { category: c0, name: c1, url: c2 };}
        return { category: c0, name: c1, content: c2 };
      });
    });
}
let allReleaseNotes = [];

async function loadReleaseNotes() {
  const ul = document.getElementById('change-log');
  
  const rows = await fetchSheet('Release Notes');
  allReleaseNotes = rows.map(({ time, text }) => {
    let dateObj;
    if (typeof time === 'string' && time.startsWith('Date(')) {
      const parts = time.slice(5, -1).split(',').map(n => Number(n));
      dateObj = new Date(parts[0], parts[1], parts[2], parts[3], parts[4], parts[5]);
    } else {
      dateObj = new Date(time);
    }
    return { time: formatTimestamp(dateObj), text };
  });

  renderReleaseNotes();
}

function renderReleaseNotes() {
  const ul = document.getElementById('change-log');
  const filterVal = (document.getElementById('changelog-filter')?.value || '').toLowerCase();
  const filtered = allReleaseNotes.filter(n => n.text.toLowerCase().includes(filterVal));
  ul.innerHTML = filtered.length
    ? filtered.map(n => `<li class="py-2">${n.time}: ${n.text}</li>`).join('')
    : '<li class="py-2 text-gray-500">No matching release notes.</li>';
}

document.getElementById('changelog-filter').addEventListener('input', renderReleaseNotes);
  document.getElementById('changelog-filter-toggle').onclick = () =>
  document.getElementById('changelog-filter-container').classList.toggle('hidden');

  // recently-viewed dropdown
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('recent-btn'),
          dd  = document.getElementById('recent-dropdown');
    btn.onclick = e => {
      e.stopPropagation();
      dd.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!dd.classList.contains('hidden')));
    };
    document.addEventListener('click', e => {
      if (
        !dd.classList.contains('hidden') &&
        !btn.contains(e.target) &&
        !dd.contains(e.target)
      ) {
        dd.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // ‚ÄúWhat‚Äôs Changed‚Äù via SSE
  const CHANGE_LOG_KEY = 'changeLogEntries';
  function saveCL(v){ localStorage.setItem(CHANGE_LOG_KEY, JSON.stringify(v)); }
  function loadCL(){ return JSON.parse(localStorage.getItem(CHANGE_LOG_KEY) || '[]'); }
  function updateChangeLog(u){
    let a = loadCL(); a.unshift(u); saveCL(a);
    document.getElementById('change-log').innerHTML =
      a.map(e => `<div class="update-item">${e.timestamp}: ${e.message}</div>`).join('');
  }
  new EventSource('/updates').onmessage = e => updateChangeLog(JSON.parse(e.data));
  new EventSource('/events').onmessage = e => {
    const d = JSON.parse(e.data);
    const ts = new Date(d.updatedAt);
    updateChangeLog({
      timestamp: `${ts.getMonth()+1}/${ts.getDate()}/${String(ts.getFullYear()%100).padStart(2,'0')} ${((h=>h%12||12)(ts.getHours()))}:${String(ts.getMinutes()).padStart(2,'0')}${ts.getHours()<12?'AM':'PM'}`,
      message: `${d.file} changed`
    });
  };

async function updateCardBadges() {
  for (const c of cardsData) {
    if (c.slug === 'reports') continue;
    const badge = document.querySelector(`[data-slug="${c.slug}"] .badge`);
    if (!badge) continue;
    try {
      const data = await fetchSheet(c.slug);
      const items = (Array.isArray(data) ? data : Object.values(data).flat())
        .filter(i => i && i.name && i.name.toUpperCase() !== 'NAME');
      const hasUnread = items.some(item => !isItemRead(c.slug, item.name));
      badge.classList.toggle('hidden', !hasUnread);
    } catch {
      badge.classList.add('hidden');
    }
  }
}

function formatTimestamp(t) {
  const d = new Date(t);
  const MM = String(d.getMonth() + 1).padStart(2, '0');
  const DD = String(d.getDate()).padStart(2, '0');
  const YYYY = d.getFullYear();
  const h24 = d.getHours();
  const ampm = h24 < 12 ? 'AM' : 'PM';
  const h = String(h24 % 12 || 12).padStart(2, '0');
  const m = String(d.getMinutes()).padStart(2, '0');
  return `${MM}/${DD}/${YYYY} ${h}:${m} ${ampm}`;
}

  const badgeDataMap = {},
        seenNotifIds = new Set(JSON.parse(localStorage.getItem('seenNotifIds')||'[]'));
  function getReadItems(){ try{return JSON.parse(localStorage.getItem('readItems')||'{}')}catch{return {}} }
  function saveReadItems(v){ localStorage.setItem('readItems', JSON.stringify(v)); }
  function markItemRead(s,i){ let r=getReadItems(); r[s]=r[s]||[]; if(!r[s].includes(i)){ r[s].push(i); saveReadItems(r); } }
  function isItemRead(s,i){ let r=getReadItems(); return Array.isArray(r[s]) && r[s].includes(i); }
  function hasUnreadForSlug(s){ return (badgeDataMap[s]||[]).some(id => !isItemRead(s, id)); }
  function setNotifCount(n){
    const el = document.getElementById('notification-count');
    if (n > 0) { el.textContent = n; el.classList.remove('hidden'); }
    else el.classList.add('hidden');
  }
  
  const container = document.getElementById('card-container'),
        detailContainer = document.getElementById('detail-container'),
        detailTitle = document.getElementById('detail-title'),
        detailList = document.getElementById('detail-list'),
        backBtn = document.getElementById('back-btn'),
        overlay = document.getElementById('overlay'),
        overlayDialog = overlay.querySelector('[tabindex="-1"]'),
        overlayClose = document.getElementById('overlay-close'),
        copyBtn = document.getElementById('copy-btn'),
        overlayHeader = document.getElementById('overlay-header'),
        overlayBody = document.getElementById('overlay-body'),
        searchInput = document.getElementById('search-input'),
        searchSuggestions = document.getElementById('search-suggestions'),
        notifBtn = document.getElementById('notification-btn'),
        notifDropdown = document.getElementById('notification-dropdown'),
        notifListEl = document.getElementById('notification-list'),
        updatesFilterToggle = document.getElementById('updates-filter-toggle'),
        updatesFilterContainer = document.getElementById('updates-filter-container'),
        updatesFilter = document.getElementById('updates-filter'),
        updatesContainer = document.getElementById('updates-container'),
        mobileUpdatesFilterToggle = document.getElementById('mobile-updates-filter-toggle'),
        mobileUpdatesFilterContainer = document.getElementById('mobile-updates-filter-container'),
        mobileUpdatesFilter = document.getElementById('mobile-updates-filter'),
        mobileUpdatesContainer = document.getElementById('mobile-updates-container'),
        toTopBtn = document.getElementById('to-top');

  const cardsData = [
    { title: 'Email Templates', slug: 'email-templates', description: 'Browse pre-built email templates.' },
    { title: 'Processes',       slug: 'processes',      description: 'Step-by-step how-to guides and workflows.' },
    { title: 'Reports',         slug: 'reports',        description: 'Access performance and usage reports.' },
    { title: 'Links',           slug: 'links',          description: 'Quick access to essential resources.' },
    { title: 'Tutorials',       slug: 'tutorials',      description: 'Video lessons to guide you through every step.' },
    { title: 'Directory',       slug: 'directory',      description: 'Key people to contact.' }
  ];

  const contentCache = {},
        debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

  function renderRecentlyViewed(recents) {
    const ul = document.getElementById('recent-list');
    ul.innerHTML = '';
    if (!recents.length) {
      ul.innerHTML = '<li class="py-2 text-gray-500 italic">No recently viewed items</li>';
      return;
    }
    recents.forEach(item => {
      const li = document.createElement('li');
      li.className = 'py-2 text-indigo-600 hover:underline cursor-pointer';
      li.textContent = item.title;
      li.onclick = () => item.type === 'card'
        ? showContent(item.slug, item.title)
        : openEmailOverlay(item.title, item.content, item.slug);
      ul.appendChild(li);
    });
  }
  function addToRecents(item) {
    const key = 'recentlyViewed',
          arr = JSON.parse(localStorage.getItem(key) || '[]'),
          filtered = arr.filter(r => !(r.slug === item.slug && r.id === item.id));
    filtered.unshift(item);
    localStorage.setItem(key, JSON.stringify(filtered.slice(0, 10)));
    renderRecentlyViewed(filtered);
  }

function iconFor(t) { return { updates:'üîî','email-templates':'‚úâÔ∏è',processes:'üõ†Ô∏è',reports:'üìä',links:'üîó',tutorials:'üé•',directory:'üìá' }[t] || 'üÜï'; }
function renderCards() {
  container.innerHTML = '';
  cardsData.forEach(c => {
    const art = document.createElement('article');
    art.dataset.slug = c.slug;
    art.className = 'relative bg-white rounded-lg shadow hover:shadow-lg transform transition-transform hover:-translate-y-1 hover:scale-[1] p-6 flex flex-col';
    const badge = document.createElement('span'); badge.className = 'badge absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full hidden'; badge.textContent = 'new';
    const header = document.createElement('div'); header.className = 'flex items-center mb-2';
    const iconEl = document.createElement('span'); iconEl.className = 'text-2xl text-gray-600 mr-2'; iconEl.textContent = iconFor(c.slug);
    const title = document.createElement('h3'); title.tabIndex = 0; title.className = 'text-xl font-semibold hover:text-indigo-600 cursor-pointer'; title.textContent = c.title; title.onclick = () => showContent(c.slug, c.title); header.append(iconEl, title);
    const desc = document.createElement('p'); desc.className = 'text-gray-600 flex-1'; desc.textContent = c.description;
    const btn = document.createElement('button'); btn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white mt-4 font-medium px-4 py-2 rounded-lg transition'; btn.textContent = `View ${c.title} ‚Üí`; btn.onclick = () => showContent(c.slug, c.title);
    art.append(badge, header, desc, btn); container.appendChild(art);
  });
  updateCardBadges();
}

  async function showContent(slug, title) {
    addToRecents({ id: slug, slug, title, type: 'card' });
    container.classList.add('hidden');
    detailContainer.classList.remove('hidden');
    detailTitle.textContent = title;
    detailList.innerHTML = '';

if (slug === 'links') {
  const raw = await fetchSheet('links');
  const items = raw.slice(1);
  const groups = items.reduce((acc, item) => {
    const key = item.category || '';
    (acc[key] = acc[key]||[]).push(item);
    return acc;
  }, {});
  for (const [cat, list] of Object.entries(groups)) {
    if (cat) {
      const h3 = document.createElement('h3');
      h3.className   = 'text-lg font-semibold mt-4';
      h3.textContent = cat;
      detailList.appendChild(h3);
    }
list.forEach(i => {
  const li = document.createElement('li');

  // 1) your existing link
  const a = document.createElement('a');
  a.href        = i.url;
  a.textContent = i.name;
  a.target      = '_blank';
  a.rel         = 'noopener noreferrer';
  a.className   = 'text-indigo-600 hover:underline';

  // 2) the unread-dot
  const dot = document.createElement('span');
  dot.className = 'ml-2 inline-block w-2 h-2 bg-red-600 rounded-full';
  if (isItemRead('links', i.name)) dot.classList.add('hidden');

  // 3) on click, mark read and hide dot
  a.addEventListener('click', () => {
    markItemRead('links', i.name);
    dot.classList.add('hidden');
    updateCardBadges();
  });

  // 4) append both
  li.append(a, dot);
  detailList.appendChild(li);
});

  }
  return;
}

if (slug === 'reports') {
  console.log('üçí building report charts');
  const sheetId = '1cfLvub1zli1txycgl1TZxKr_oUMvqUrhkRwkJ6UG5hw';
  const makeUrl = tab =>
    `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json`;

  detailList.innerHTML = `
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div><p class="mb-2"><a href="https://netorgft5128391.sharepoint.com/:f:/s/WooParts/EjpDWNP2fWpGjFnWrrLQm5YBrQbi5brC2b1icKhK2HgoQg?e=lXACY4" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">WooParts Profit &amp; Loss Report ‚Äì 2025</a>
</p><canvas id="profitChartA" class="w-full h-64"></canvas></div>
    <div><p class="mb-2"><a href="https://netorgft5128391.sharepoint.com/:f:/s/WooParts/EoxeUapprzhKqElf0c-ZIfkBfyEU9gAmQc_HZ_sGtezAag?e=hcH8HA" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">AutoApex Profit &amp; Loss Report ‚Äì 2025</a></p><canvas id="profitChartB" class="w-full h-64"></canvas></div>
    </div>
  `;

  ['WooParts P/L', 'AutoApex P/L'].forEach((tab, idx) => {
    fetch(makeUrl(tab))
      .then(r => r.text())
      .then(raw => {
        const json = JSON.parse(raw.substr(47).slice(0, -2));
        console.log(`${tab} rows:`, json.table.rows.length);
        const rows    = json.table.rows;
        const labels  = rows.map(r => r.c[0]?.v);
        const profits = rows.map(r => r.c[1]?.v);
        const margins = rows.map(r => r.c[2]?.v);
        const ctx     = document
                        .getElementById(idx === 0 ? 'profitChartA' : 'profitChartB')
                        .getContext('2d');

      const myChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels,
    datasets: [
      { label: 'Net Profit',       data: profits,  backgroundColor: 'rgba(54,162,235,0.5)' },
      { label: 'Net Profit Margin %', data: margins, backgroundColor: 'rgba(255,159,64,0.5)', yAxisID: 'marginAxis' }
    ]
  },
options: {
  responsive: true,
  scales: {
    x: {
      title: { display: true, text: 'Week Numbers' }
    },
    y: {
      beginAtZero: true,
      title: { display: true, text: 'Net Profit' }
    },
    marginAxis: {
      beginAtZero: true,
      position: 'right',
      grid: { drawOnChartArea: false },
      title: { display: true, text: 'Net Profit Margin %' },
      ticks: {
        callback: v => (v * 100).toFixed(2) + '%'
      }
    }
  },
  plugins: {
    tooltip: {
      callbacks: {
        label: ctx =>
          ctx.dataset.label === 'Margin (%)'
            ? (ctx.parsed.y * 100).toFixed(2) + '%'
            : ctx.parsed.y.toFixed(2)
      }
    },
    legend: {
      
        onClick(e, legendItem, legend) {
          Chart.defaults.plugins.legend.onClick.call(this.chart, e, legendItem, legend);
          const ds = this.chart.data.datasets[legendItem.datasetIndex];
          if (ds.yAxisID === 'marginAxis') {
            this.chart.options.scales.marginAxis.title.text = 'Net Profit Margin %';
          } else {
            this.chart.options.scales.y.title.text = 'Net Profit';
          }
          this.chart.update();
        }
      }
    }
  }
});
      })
      .catch(err => console.error(`Error loading ${tab}:`, err));
  });

  return;
}

    try {
// fetch flat array: [{category, name, content}, ...]
const rawItems = await fetchSheet(slug);

// drop the header row that reads ["CATEGORY","Name",‚Ä¶]
const items = rawItems.filter(i => 
  !(i.category?.toUpperCase() === 'CATEGORY' && i.name?.toUpperCase() === 'NAME')
);

// now group by the real category values
const groups = items.reduce((acc, item) => {
  const key = item.category || '';
  if (!acc[key]) acc[key] = [];
  acc[key].push(item);
  return acc;
}, {});

// render each category
for (const [cat, list] of Object.entries(groups)) {
  if (cat) {
    const h = document.createElement('h3');
    h.className   = 'text-lg font-semibold mt-4';
    h.textContent = cat.toUpperCase();    // or leave as-is
    detailList.appendChild(h);
  }
  list.forEach(i => {
    const li  = document.createElement('li');
    const btn = document.createElement('button');
    btn.className   = 'flex items-center text-indigo-600 hover:underline focus:outline-none';
    btn.textContent = i.name;
  // create the unread-dot
  const dot = document.createElement('span');
  dot.className = 'ml-2 inline-block w-2 h-2 bg-red-600 rounded-full';
  if (isItemRead(slug, i.name)) dot.classList.add('hidden');

  // when clicked: open, mark read, hide dot, update card badge
btn.addEventListener('click', () => {
  openEmailOverlay(i.name, i.content, slug);
  markItemRead(slug, i.name); // or .id if that's the true key
  dot.classList.add('hidden');
  updateCardBadges();
});
  // compose
  btn.appendChild(dot);
  li.appendChild(btn);
  detailList.appendChild(li);
});
}

    } catch {
      detailList.innerHTML = '<li class="text-red-500">This page is under construction ‚Äì check back soon!</li>';
    }
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Tab' && !overlay.classList.contains('hidden')) {
      const focusable = Array.from(overlayDialog.querySelectorAll('button,[href],input,textarea,[tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled),
            idx = focusable.indexOf(document.activeElement);
      if (e.shiftKey && idx === 0) { focusable[focusable.length-1].focus(); e.preventDefault(); }
      else if (!e.shiftKey && idx === focusable.length-1) { focusable[0].focus(); e.preventDefault(); }
    }
  });

  let lastFocused;
  function openEmailOverlay(name, html, slug) {
    lastFocused = document.activeElement;
    document.documentElement.style.overflow = '';
    overlayHeader.textContent = name;
    const c = cardsData.find(x => x.slug === slug);
    overlayBody.innerHTML = `${c ? `<h3 class="text-lg font-semibold mb-2">${c.title}</h3>` : ''}<div class="prose max-w-none space-y-4">${html}</div>`;
    addToRecents({ id: name, slug, title: name, content: html, type: 'item' });
    overlay.classList.remove('hidden');
    overlayDialog.classList.add('opacity-100','scale-100');
    copyBtn.classList.remove('hidden');
    overlayClose.focus();
  }
  overlayClose.onclick = () => {
    overlay.classList.add('hidden');
    overlayDialog.classList.remove('opacity-100','scale-100');
    document.documentElement.style.overflow = '';
    lastFocused && lastFocused.focus();
  };
  overlay.onclick = e => { if (e.target === overlay) overlayClose.click(); };
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(overlayBody.innerText).then(() => {
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy', 2000);
    });
  };

  backBtn.onclick = () => {
    detailContainer.classList.add('hidden');
    container.classList.remove('hidden');
    document.documentElement.style.overflow = '';
  };
  window.addEventListener('scroll', () => { toTopBtn.classList.toggle('hidden', window.scrollY < 300); });
  toTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

  function iconFor(t) { return { updates:'üîî','email-templates':'‚úâÔ∏è',processes:'üõ†Ô∏è',reports:'üìä',links:'üîó',tutorials:'üé•',directory:'üìá' }[t] || 'üÜï'; }
  function getRelativeTime(d) {
    const diff = (new Date() - d) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff/60)} min${Math.floor(diff/60)>1?'s':''} ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)} hour${Math.floor(diff/3600)>1?'s':''} ago`;
    return d.toLocaleDateString();
  }

const NKEY = 'notifications', SKEY = 'seenNotifIds';

function getRelativeTime(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000); // seconds
  if (diff < 60) return 'just now';
  if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)} hour${Math.floor(diff / 3600) > 1 ? 's' : ''} ago`;
  return date.toLocaleDateString();
}
function parseGoogleDate(str) {
  const m = /^Date\(([\d,]+)\)$/.exec(str);
  if (!m) return new Date(str);
  const parts = m[1].split(',').map(Number);
  return new Date(parts[0], parts[1], parts[2], parts[3], parts[4], parts[5]);
}
async function syncNotificationsFromSheet() {
  const rows = await fetchSheet('notifications');
  console.log('Fetched notification rows:', rows);
  if (rows.length) console.log('First row:', rows[0]);
  const dataRows = rows;

  const notifications = dataRows
    .filter(row => row && row.time && row.text)
    .map(({ time, text }) => {
      let dateObj;
      if (typeof time === 'string' && time.startsWith('Date(')) {
        dateObj = parseGoogleDate(time);
      } else {
        dateObj = new Date(time);
      }
      return {
        id: encodeURIComponent(String(time) + text),
        text,
        time: dateObj.toISOString()
      };
    });

  console.log('Processed notifications:', notifications);
  localStorage.setItem('notifications', JSON.stringify(notifications));
}

function pollNotifications() {
  const nots = JSON.parse(localStorage.getItem('notifications') || '[]');
  const seen = new Set(JSON.parse(localStorage.getItem(SKEY) || '[]'));
  const unread = nots.filter(x => !seen.has(x.id));
  const all = [...unread, ...nots.filter(x => seen.has(x.id))];
  const ul = document.getElementById('notification-list');
  ul.innerHTML = '';

  for (let i of all) {
    let li = document.createElement('li'),
        wr = document.createElement('div'),
        tm = document.createElement('span');
    let isUnread = !seen.has(i.id);

    if (isUnread) {
      let b = document.createElement('span');
      b.textContent = 'New ';
      b.className = 'new-badge text-red-600 text-xs font-semibold mr-1';
      wr.appendChild(b);
    }
    wr.appendChild(Object.assign(document.createElement('span'), { textContent: `üîî ${i.text}` }));

    let d = typeof i.time === 'string' ? new Date(i.time) : i.time;
    tm.textContent = getRelativeTime(d);
    tm.title = d.toLocaleString(); // actual date on hover
    li.className = 'p-2 border-b hover:bg-gray-50 flex justify-between items-center';
    li.append(wr, tm);

    li.style.cursor = "pointer";
    li.onclick = () => {
      if (isUnread) {
        seen.add(i.id);
        localStorage.setItem(SKEY, JSON.stringify([...seen]));
        pollNotifications();
      }
    };
    ul.appendChild(li);
  }
function markAllNotifsAsRead() {
  const nots = JSON.parse(localStorage.getItem('notifications') || '[]');
  const allIds = nots.map(x => x.id);
  localStorage.setItem('seenNotifIds', JSON.stringify(allIds));
}
const notifBtn = document.getElementById('notification-btn');
const notifDropdown = document.getElementById('notification-dropdown');

notifBtn.onclick = function(e) {
  const open = !notifDropdown.classList.toggle('hidden');
  e.currentTarget.setAttribute('aria-expanded', open);
  e.stopPropagation();

  if (!open) {
    markAllNotifsAsRead();
    pollNotifications();
  }
};

  document.addEventListener('click', function(e) {
  if (
    !notifDropdown.classList.contains('hidden') &&
    !notifBtn.contains(e.target) &&
    !notifDropdown.contains(e.target)
  ) {
    notifDropdown.classList.add('hidden');
    notifBtn.setAttribute('aria-expanded', 'false');
    markAllNotifsAsRead();
    pollNotifications();
  }
});

  const el = document.getElementById('notification-count');
  if (unread.length > 0) {
    el.textContent = unread.length;
    el.classList.remove('hidden');
  } else {
    el.classList.add('hidden');
  }
  
  if (typeof updateCardBadges === 'function') updateCardBadges();
}

async function initNotifications() {
  await syncNotificationsFromSheet();
  pollNotifications();
  setInterval(async () => {
    await syncNotificationsFromSheet();
    pollNotifications();
  }, 60000);
}

document.addEventListener('DOMContentLoaded', initNotifications);

let allUpdates = []; const displayCount = 10; let initialUpdatesLoad = true;

async function pollUpdatesPanel() {
  try {
    const rows = await fetchSheet('Announcements');
    allUpdates = rows.map(({ time, text }) => {
      let dateObj;
      if (typeof time === 'string' && time.startsWith('Date(')) {
        const parts = time
          .slice(5, -1) .split(',') .map(n => Number(n));
        dateObj = new Date(parts[0], parts[1],  parts[2], parts[3], parts[4], parts[5]);
      } else {
        dateObj = new Date(time);
      }
      return {
        time: formatTimestamp(dateObj),
        text
      };
    });

    renderUpdatesPanel();
  } catch (err) {
    console.error('pollUpdatesPanel error:', err);
  }
}

function renderUpdatesPanel() {
  const filterVal = (updatesFilter?.value || mobileUpdatesFilter?.value || '').toLowerCase();
  const filtered = allUpdates
    .filter(u => u.text.toLowerCase().includes(filterVal))
    .sort((a, b) => new Date(b.time) - new Date(a.time));
  const slice     = filtered.slice(0, displayCount);
  const lastSeen  = localStorage.getItem('lastSeenUpdate');
  const latestTime= slice[0]?.time;
  const isNew     = latestTime && latestTime !== lastSeen;

  [updatesContainer, mobileUpdatesContainer].forEach(listEl => {
    listEl.innerHTML = '';

    if (slice.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No updates available.';
      li.className  = 'py-2 text-gray-500';
      listEl.appendChild(li);
      return;
    }

slice.forEach((u, idx) => {
  const li = document.createElement('li');
  li.className = 'py-2';
  if (idx === 0 && initialUpdatesLoad && isNew) {
    document.getElementById('update-banner')
      .classList.replace('hidden','show');
    document.getElementById('update-banner-content')
      .textContent = u.text;
  }
  const latestUpdate = slice[0];
  const bannerDismissedKey = "updateBannerDismissed";
  const bannerContent = latestUpdate?.text || "";
  
if (latestUpdate) {
  const banner = document.getElementById("update-banner");
  banner.classList.replace("hidden", "show");
  document.getElementById("update-banner-content").textContent = bannerContent;
}
const banner = document.getElementById("update-banner");
const bannerClose = document.getElementById("update-banner-close");

bannerClose.addEventListener("click", () => {
  banner.classList.remove("show");
  banner.classList.add("hidden");
});

  li.textContent = `${u.time}: ${u.text}`;
  listEl.appendChild(li);
  });
});

  if (isNew) localStorage.setItem('lastSeenUpdate', latestTime);
  initialUpdatesLoad = false;
}

pollUpdatesPanel();
setInterval(pollUpdatesPanel, 60_000);

updatesFilterToggle.onclick = () => updatesFilterContainer.classList.toggle('hidden');

function renderChangeLog() {
  const fv = changelogFilter.value.toLowerCase();
  const entries = loadCL();
  const filtered = entries.filter(e =>
    e.message.toLowerCase().includes(fv)
  );
  const listHtml = filtered.length
    ? filtered.map(e => `<li class="py-2">${e.timestamp}: ${e.message}</li>`).join('')
    : '<li class="py-2 text-gray-500">No matching updates.</li>';
  document.getElementById('change-log').innerHTML = listHtml;}
  mobileUpdatesFilterToggle.onclick = () => mobileUpdatesFilterContainer.classList.toggle('hidden');
  updatesFilter?.addEventListener('input', debounce(renderUpdatesPanel,200));
  mobileUpdatesFilter?.addEventListener('input', debounce(renderUpdatesPanel,200));

  let fuse;
  async function buildSearchIndex() {
    const items = cardsData.map(c=>({name:c.title,content:c.description,slug:c.slug,isRoot:true}));
    for (const c of cardsData) if (c.slug!=='reports') {
      try {
        const d = await fetchSheet(c.slug);
        const arr = Array.isArray(d)?d:Object.values(d).flat();
        arr.forEach(i=>items.push({name:i.name,content:i.content,slug:c.slug,isRoot:false}));
      } catch {}}
    fuse = new Fuse(items,{keys:['name','content'],includeMatches:true,threshold:0.4});}
  function renderSuggestions(results) {
    searchSuggestions.innerHTML = '';
    if (!results.length) {
      searchSuggestions.innerHTML = '<li class="px-4 py-2 text-gray-500">No results</li>';
    } else results.forEach(r => {
      let label = r.item.name;
      const m = r.matches.find(x=>x.key==='name');
      if (m) {
        let h='', last=0;
        m.indices.forEach(([s,e])=>{ h+=label.slice(last,s)+`<mark>${label.slice(s,e+1)}</mark>`; last=e+1; });
        h+=label.slice(last); label=h;
      }
      const li = document.createElement('li');
      li.role='option'; li.className='px-4 py-2 hover:bg-gray-100 cursor-pointer';
      li.innerHTML=label;
      li.onclick = () => {
        (r.item.isRoot?showContent:openEmailOverlay)(r.item.slug||r.item.name,r.item.content,r.item.slug);
        searchSuggestions.classList.add('hidden');
        searchInput.setAttribute('aria-expanded','false');
      };
      searchSuggestions.appendChild(li);
    });
  }
  searchInput.addEventListener('input', debounce(async e=>{
    const q = e.target.value.trim();
    if (!q) return searchSuggestions.classList.add('hidden');
    if (!fuse) await buildSearchIndex();
    renderSuggestions(fuse.search(q));
    searchSuggestions.classList.remove('hidden');
    searchInput.setAttribute('aria-expanded','true');
  },250));
  document.addEventListener('keydown', e => {
    if (e.key==='/' && document.activeElement!==searchInput) {
      e.preventDefault();
      searchInput.focus();
    }
  });

document.addEventListener("DOMContentLoaded", async () => {
  const PASSCODE = 'WooAA2025';  // ‚Üê change to your secret
  const overlay = document.getElementById('passcode-overlay');
  const input   = document.getElementById('passcode-input');
  const btn     = document.getElementById('passcode-submit');
  const error   = document.getElementById('passcode-error');
  function checkPasscode() {
    if (input.value === PASSCODE) {
      overlay.style.display = 'none';
    } else {
      error.style.display = 'block';
      input.value = '';
      input.focus();
    }
  }

  btn.addEventListener('click', checkPasscode);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') checkPasscode();
  });
const tabRecent   = document.getElementById('tab-recent');
const tabWhatsNew = document.getElementById('tab-whatsnew');
const panelRec    = document.getElementById('panel-recent');
const panelNew    = document.getElementById('panel-whatsnew');

function activateTab(activeTab, inactiveTab, showPanel, hidePanel) {
  activeTab.classList.replace('text-gray-600', 'text-gray-900');
  activeTab.classList.replace('border-transparent', 'border-indigo-600');
  inactiveTab.classList.replace('text-gray-900', 'text-gray-600');
  inactiveTab.classList.replace('border-indigo-600', 'border-transparent');
  showPanel.classList.remove('hidden');
  hidePanel.classList.add('hidden');
}

tabRecent.addEventListener('click', () =>
  activateTab(tabRecent, tabWhatsNew, panelRec, panelNew)
);

tabWhatsNew.addEventListener('click', () => {
  activateTab(tabWhatsNew, tabRecent, panelNew, panelRec);
  loadReleaseNotes();
});

  renderRecentlyViewed(JSON.parse(localStorage.getItem("recentlyViewed") || "[]"));
  renderCards();
  buildSearchIndex();
  
});
  const banner       = document.getElementById('update-banner');
  const bannerClose  = document.getElementById('update-banner-close');

bannerClose.addEventListener('click', () => {
  banner.classList.remove('show');
  banner.classList.add('hidden');
  localStorage.setItem('bannerClosedFor', document.getElementById('update-banner-content').textContent);
});
  document.getElementById('notification-btn').onclick = function(e) {
    const dd = document.getElementById('notification-dropdown');
    const open = !dd.classList.toggle('hidden');
    e.currentTarget.setAttribute('aria-expanded', open);
    e.stopPropagation();
  };

  new EventSource('/updates').onmessage = e => {
    const update = JSON.parse(e.data);
    const entries = JSON.parse(localStorage.getItem('changeLogEntries') || '[]');
    entries.unshift(update);
    localStorage.setItem('changeLogEntries', JSON.stringify(entries));
    document.getElementById('change-log').innerHTML = entries.map(e =>
      `<div class="update-item">${e.timestamp}: ${e.message}</div>`
    ).join('');
  };

</script>
</body>
</html>
