<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>WooHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js" defer></script>
  <style>
    @keyframes bell-bounce{0%,100%{transform:rotate(0)}25%{transform:rotate(10deg)}75%{transform:rotate(-10deg)}}
    @keyframes gradient-slide{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .suggestion-enter{transform:translateX(-20px);opacity:0}
    .suggestion-enter-active{animation:slide-in .3s forwards}
    @keyframes slide-in{to{transform:translateX(0);opacity:1}}
    @keyframes slide-down{from{transform:translateY(-100%)}to{transform:translateY(0)}}
    #update-banner.show{animation:slide-down .3s ease-out forwards}
    #update-banner {position: fixed; top: 4rem; left: 0; right: 0; z-index: 10; width: 100%;}
    #overlay ol{list-style:decimal}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased flex flex-col min-h-screen">

  <div id="parallax-bg" class="fixed inset-0 bg-[url('/assets/pattern.svg')] bg-center bg-cover pointer-events-none"></div>
  <noscript><div class="p-4 bg-yellow-100 text-yellow-800">JavaScript is required to use WooHub.</div></noscript>

  <header class="relative bg-white shadow sticky top-0 z-20 flex items-center justify-between h-16 px-4 lg:px-8">
    <a href="#" onclick="event.preventDefault()" class="h-16 flex items-center">
      <img src="assets/woohub_logo.png" alt="Logo" class="h-10"/>
    </a>
    <div class="absolute left-1/2 transform -translate-x-1/2 w-full max-w-lg">
      <input id="search-input" type="search" placeholder="Search keywords..."
             aria-autocomplete="list" aria-controls="search-suggestions"
             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none focus:ring-indigo-500"/>
      <ul id="search-suggestions"
          class="hidden absolute left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-auto z-30"></ul>
    </div>
    <div class="flex items-center">
      <div class="relative">
        <button id="notification-btn" class="p-2">
          <svg id="bellIcon" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
          <span id="notification-count"
                class="hidden absolute -top-1 -right-1 inline-flex items-center justify-center px-1 text-xs font-bold text-white bg-red-600 rounded-full"></span>
        </button>
        <div id="notification-dropdown"
             class="hidden absolute right-0 mt-2 w-96 p-4 bg-white border rounded-lg shadow-lg z-40">
          <ul id="notification-list" class="max-h-64 overflow-y-auto divide-y divide-gray-200"></ul>
          <div class="text-center p-2">
            <button id="clear-notifications" class="text-indigo-600 hover:underline">Clear All</button>
          </div>
        </div>
      </div>
      <div class="relative ml-4">
        <button id="recent-btn" class="p-2">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </button>
        <div id="recent-dropdown"
             class="hidden absolute right-0 mt-2 w-72 p-4 bg-white border rounded-lg shadow-lg z-40">
          <ul id="recent-list" class="max-h-60 overflow-y-auto divide-y divide-gray-200"></ul>
        </div>
      </div>
    </div>
  </header>

  <div id="update-banner" class="hidden bg-indigo-600 text-white flex items-center justify-center px-6 py-3 relative">
    <div id="update-banner-content" class="flex-1 text-sm font-medium text-center"></div>
    <button id="update-banner-close" class="absolute right-4 text-xl font-bold focus:outline-none">&times;</button>
  </div>

  <details class="lg:hidden px-4 mt-2">
    <summary class="flex justify-between font-semibold cursor-pointer">
      <span>Recent Updates</span>
      <button id="mobile-updates-filter-toggle" class="p-1 focus:outline-none"></button>
    </summary>
    <div class="mt-2 space-y-2">
      <div id="mobile-updates-filter-container" class="hidden">
        <input id="mobile-updates-filter" type="text" placeholder="Filter updates..."
               class="w-full px-3 py-1 mb-2 border rounded-lg focus:ring-1 focus:outline-none focus:ring-indigo-500"/>
      </div>
      <ul id="mobile-updates-container" class="max-h-60 overflow-y-auto space-y-2 pr-2"></ul>
      <button id="mobile-load-more-btn" class="w-full mt-2 text-indigo-600 hover:underline">Load More</button>
    </div>
  </details>
<div class="flex flex-1 w-full max-w-[2000px] mx-auto px-4 pt-6 pb-6">
  <aside class="hidden lg:block w-80 lg:w-96 mr-6 space-y-6 pb-6">
    <div class="bg-white border rounded-lg p-4 sticky top-24">
      <div class="flex justify-between mb-2">
        <h2 class="font-semibold text-lg">Recent Updates</h2>
        <button id="updates-filter-toggle" class="p-1 text-gray-600 hover:text-gray-800">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
       viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round"
          d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414a1
                  1 0 00-.293.707V19l-4-2v-4.172a1 1 0 00-.293-.707L3.293 6.707A1 1 0
                  013 6V4z"/>
  </svg>
</button>

      </div>
      <div id="updates-filter-container" class="hidden mb-2">
        <input id="updates-filter" type="text" placeholder="Filter updates..." class="w-full p-2 border rounded"/>
      </div>
      <ul id="updates-container" class="max-h-96 overflow-y-auto pr-2 space-y-2"></ul>
    </div>
<div class="bg-white border rounded-lg p-4 sticky top-[calc(6rem+1.5rem)]">
  <div class="flex justify-between mb-2">
    <h2 class="font-semibold text-lg">What's New and Different?</h2>
    <button id="changelog-filter-toggle" class="p-1 text-gray-600 hover:text-gray-800">
      <!-- you can reuse the same Heroicons filter SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414a1
                      1 0 00-.293.707V19l-4-2v-4.172a1 1 0 00-.293-.707L3.293 6.707A1 1 0
                      013 6V4z"/>
      </svg>
    </button>
  </div>
  <div id="changelog-filter-container" class="hidden mb-2">
    <input id="changelog-filter" type="text" placeholder="Filter changes..."
           class="w-full p-2 border rounded"/>
  </div>
  <ul id="change-log" class="max-h-40 overflow-y-auto pr-2 space-y-2">
    <li class="text-gray-600">No updates yet...</li>
  </ul>
</div>
  </aside>

  <main class="relative flex-1 flex flex-col">
    <nav class="text-sm mb-4">
      <ol class="flex text-gray-600">
        <li><a href="#" onclick="event.preventDefault()" class="hover:underline">Home</a></li>
        <li><span class="mx-2">/</span></li>
        <li>Dashboard</li>
      </ol>
    </nav>
    
    <section id="detail-container"
             class="hidden absolute inset-0 bg-white rounded-lg shadow p-6 flex flex-col"
             style="height:calc(100% - 1rem);max-height:calc(100vh - 1rem);overflow-y:auto;margin-bottom:1rem;">
      <button id="back-btn"
              class="self-start mb-4 font-medium text-indigo-600 hover:underline focus:outline-none">
        ← Back to Dashboard
      </button>
      <h2 id="detail-title" class="text-2xl font-semibold mb-4"></h2>
      <ul id="detail-list" class="flex-1 overflow-y-auto list-disc pl-5 space-y-2"></ul>
    </section>

    <section id="card-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"></section>
  </main>
</div>

<div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 items-start justify-center overflow-y-auto z-40">
  <div class="relative mt-20 mx-auto w-11/12 md:w-3/4 lg:w-1/2 max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-lg p-6" tabindex="-1">
    <button id="overlay-close" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-700">&times;</button>
    <button id="copy-btn" class="absolute top-4 right-12 text-sm text-gray-500 hover:text-gray-700 hidden">Copy</button>
    <h2 id="overlay-header" class="text-2xl font-semibold mb-4"></h2>
    <div id="overlay-body" class="space-y-4" tabindex="0"></div>
  </div>
</div>

<button id="to-top" class="hidden fixed bottom-6 right-6 p-3 bg-indigo-600 text-white rounded-full shadow-lg">↑</button>

<footer class="bg-white border-t">
  <div class="flex justify-between items-center h-14 px-4">
    <p class="text-sm text-gray-500">&copy; 2025 WooHub. All rights reserved.</p>
    <p class="text-sm text-gray-500">Developed By: Christine Anastacio</p>
  </div>
</footer>
<script>
  // recently-viewed dropdown
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('recent-btn'),
          dd  = document.getElementById('recent-dropdown');
    btn.onclick = e => {
      e.stopPropagation();
      dd.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!dd.classList.contains('hidden')));
    };
    document.addEventListener('click', e => {
      if (
        !dd.classList.contains('hidden') &&
        !btn.contains(e.target) &&
        !dd.contains(e.target)
      ) {
        dd.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // “What’s Changed” via SSE
  const CHANGE_LOG_KEY = 'changeLogEntries';
  function saveCL(v){ localStorage.setItem(CHANGE_LOG_KEY, JSON.stringify(v)); }
  function loadCL(){ return JSON.parse(localStorage.getItem(CHANGE_LOG_KEY) || '[]'); }
  function updateChangeLog(u){
    let a = loadCL(); a.unshift(u); saveCL(a);
    document.getElementById('change-log').innerHTML =
      a.map(e => `<div class="update-item">${e.timestamp}: ${e.message}</div>`).join('');
  }
  document.addEventListener('DOMContentLoaded', () => {
    let a = loadCL();
    document.getElementById('change-log').innerHTML = a.length
      ? a.map(e => `<div class="update-item">${e.timestamp}: ${e.message}</div>`).join('')
      : '<p>No updates yet...</p>';
  });
  new EventSource('/updates').onmessage = e => updateChangeLog(JSON.parse(e.data));
  new EventSource('/events').onmessage = e => {
    const d = JSON.parse(e.data);
    const ts = new Date(d.updatedAt);
    updateChangeLog({
      timestamp: `${ts.getMonth()+1}/${ts.getDate()}/${String(ts.getFullYear()%100).padStart(2,'0')} ${((h=>h%12||12)(ts.getHours()))}:${String(ts.getMinutes()).padStart(2,'0')}${ts.getHours()<12?'AM':'PM'}`,
      message: `${d.file} changed`
    });
  };

  // updateCardBadges: show “new” badge if any unread items exist for each card
  async function updateCardBadges() {
    for (const c of cardsData) {
      const badge = document.querySelector(`[data-slug="${c.slug}"] .badge`);
      if (!badge) continue;
      try {
        const data = await fetchItems(c.slug);
        const items = Array.isArray(data) ? data : Object.values(data).flat();
        const hasUnread = items.some(item => {
          const id = item.id || item.name;
          return !isItemRead(c.slug, id);
        });
        badge.classList.toggle('hidden', !hasUnread);
      } catch {}
    }
  }

  function formatTimestamp(t){const d = new Date(t), M = d.getMonth()+1, D = d.getDate(), YY = String(d.getFullYear()%100).padStart(2,'0'), h24 = d.getHours(), ampm = h24 < 12 ? 'AM' : 'PM', h = h24%12 || 12, m = String(d.getMinutes()).padStart(2,'0'); return `${M}/${D}/${YY} ${h}:${m}${ampm}`;}

  const badgeDataMap = {},
        seenNotifIds = new Set(JSON.parse(localStorage.getItem('seenNotifIds')||'[]'));
  function getReadItems(){ try{return JSON.parse(localStorage.getItem('readItems')||'{}')}catch{return {}} }
  function saveReadItems(v){ localStorage.setItem('readItems', JSON.stringify(v)); }
  function markItemRead(s,i){ let r=getReadItems(); r[s]=r[s]||[]; if(!r[s].includes(i)){ r[s].push(i); saveReadItems(r); } }
  function isItemRead(s,i){ let r=getReadItems(); return Array.isArray(r[s]) && r[s].includes(i); }
  function hasUnreadForSlug(s){ return (badgeDataMap[s]||[]).some(id => !isItemRead(s, id)); }
  function setNotifCount(n){
    const el = document.getElementById('notification-count');
    if (n > 0) { el.textContent = n; el.classList.remove('hidden'); }
    else el.classList.add('hidden');
  }
  
  const container = document.getElementById('card-container'),
        detailContainer = document.getElementById('detail-container'),
        detailTitle = document.getElementById('detail-title'),
        detailList = document.getElementById('detail-list'),
        backBtn = document.getElementById('back-btn'),
        overlay = document.getElementById('overlay'),
        overlayDialog = overlay.querySelector('[tabindex="-1"]'),
        overlayClose = document.getElementById('overlay-close'),
        copyBtn = document.getElementById('copy-btn'),
        overlayHeader = document.getElementById('overlay-header'),
        overlayBody = document.getElementById('overlay-body'),
        searchInput = document.getElementById('search-input'),
        searchSuggestions = document.getElementById('search-suggestions'),
        notifBtn = document.getElementById('notification-btn'),
        notifDropdown = document.getElementById('notification-dropdown'),
        notifListEl = document.getElementById('notification-list'),
        clearNotifsBtn = document.getElementById('clear-notifications'),
        updatesFilterToggle = document.getElementById('updates-filter-toggle'),
        updatesFilterContainer = document.getElementById('updates-filter-container'),
        updatesFilter = document.getElementById('updates-filter'),
        updatesContainer = document.getElementById('updates-container'),
        mobileUpdatesFilterToggle = document.getElementById('mobile-updates-filter-toggle'),
        mobileUpdatesFilterContainer = document.getElementById('mobile-updates-filter-container'),
        mobileUpdatesFilter = document.getElementById('mobile-updates-filter'),
        mobileUpdatesContainer = document.getElementById('mobile-updates-container'),
        toTopBtn = document.getElementById('to-top');

  const cardsData = [
    { title: 'Email Templates', slug: 'email-templates', description: 'Browse pre-built email templates.' },
    { title: 'Processes',       slug: 'processes',      description: 'Step-by-step how-to guides and workflows.' },
    { title: 'Reports',         slug: 'reports',        description: 'Access performance and usage reports.' },
    { title: 'Links',           slug: 'links',          description: 'Quick access to essential resources.' },
    { title: 'Tutorials',       slug: 'tutorials',      description: 'Video lessons to guide you through every step.' },
    { title: 'Directory',       slug: 'directory',      description: 'Key people to contact.' }
  ];

  const contentCache = {},
        debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

  async function fetchItems(slug) {
    if (contentCache[slug]) return contentCache[slug];
    const res = await fetch(`data/${slug}.json`);
    if (!res.ok) throw new Error('Failed to load data');
    return contentCache[slug] = await res.json();
  }

  function renderRecentlyViewed(recents) {
    const ul = document.getElementById('recent-list');
    ul.innerHTML = '';
    if (!recents.length) {
      ul.innerHTML = '<li class="py-2 text-gray-500 italic">No recently viewed items</li>';
      return;
    }
    recents.forEach(item => {
      const li = document.createElement('li');
      li.className = 'py-2 text-indigo-600 hover:underline cursor-pointer';
      li.textContent = item.title;
      li.onclick = () => item.type === 'card'
        ? showContent(item.slug, item.title)
        : openEmailOverlay(item.title, item.content, item.slug);
      ul.appendChild(li);
    });
  }
  function addToRecents(item) {
    const key = 'recentlyViewed',
          arr = JSON.parse(localStorage.getItem(key) || '[]'),
          filtered = arr.filter(r => !(r.slug === item.slug && r.id === item.id));
    filtered.unshift(item);
    localStorage.setItem(key, JSON.stringify(filtered.slice(0, 10)));
    renderRecentlyViewed(filtered);
  }

function iconFor(t) { return { updates:'🔔','email-templates':'✉️',processes:'🛠️',reports:'📊',links:'🔗',tutorials:'🎥',directory:'📇' }[t] || '🆕'; }
function renderCards() {
  container.innerHTML = '';
  cardsData.forEach(c => {
    const art = document.createElement('article');
    art.dataset.slug = c.slug;
    art.className = 'relative bg-white rounded-lg shadow hover:shadow-lg transform transition-transform hover:-translate-y-1 hover:scale-[1] p-6 flex flex-col';
    const badge = document.createElement('span'); badge.className = 'badge absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full hidden'; badge.textContent = 'new';
    const header = document.createElement('div'); header.className = 'flex items-center mb-2';
    const iconEl = document.createElement('span'); iconEl.className = 'text-2xl text-gray-600 mr-2'; iconEl.textContent = iconFor(c.slug);
    const title = document.createElement('h3'); title.tabIndex = 0; title.className = 'text-xl font-semibold hover:text-indigo-600 cursor-pointer'; title.textContent = c.title; title.onclick = () => showContent(c.slug, c.title); header.append(iconEl, title);
    const desc = document.createElement('p'); desc.className = 'text-gray-600 flex-1'; desc.textContent = c.description;
    const btn = document.createElement('button'); btn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white mt-4 font-medium px-4 py-2 rounded-lg transition'; btn.textContent = `View ${c.title} →`; btn.onclick = () => showContent(c.slug, c.title);
    art.append(badge, header, desc, btn); container.appendChild(art);
  });
  updateCardBadges();
}

  async function showContent(slug, title) {
    addToRecents({ id: slug, slug, title, type: 'card' });
    container.classList.add('hidden');
    detailContainer.classList.remove('hidden');
    detailTitle.textContent = title;
    detailList.innerHTML = '';

    if (slug === 'links') {
      const groups = await fetchItems('links'),
            oldIds = new Set((window.initialLinks || []).map(x => x.id));
      for (const [cat, items] of Object.entries(groups)) {
        if (cat) {
          const h = document.createElement('h3');
          h.className = 'text-lg font-semibold mt-4';
          h.textContent = cat;
          detailList.appendChild(h);
        }
        items.forEach(i => {
          if (oldIds.has(i.name)) markItemRead('links', i.name);
          const li = document.createElement('li'),
                a  = Object.assign(document.createElement('a'), { href: i.url, target: '_blank', rel: 'noopener noreferrer', textContent: i.name });
          a.className = 'text-indigo-600 hover:underline';
          const dot = document.createElement('span');
          dot.className = 'ml-2 inline-block w-2 h-2 bg-red-600 rounded-full';
          if (isItemRead('links', i.name)) dot.classList.add('hidden');
          a.onclick = () => { markItemRead('links', i.name); dot.classList.add('hidden'); updateCardBadges(); };
          li.append(a, dot);
          detailList.appendChild(li);
        });
      }
      updateCardBadges();
      return;
    }

if (slug === 'reports') {
  console.log('🍒 building report charts');
  const sheetId = '1cfLvub1zli1txycgl1TZxKr_oUMvqUrhkRwkJ6UG5hw';
  const makeUrl = tab =>
    `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json`;

  detailList.innerHTML = `
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div><p class="mb-2"><a href="https://netorgft5128391.sharepoint.com/:f:/s/WooParts/EjpDWNP2fWpGjFnWrrLQm5YBrQbi5brC2b1icKhK2HgoQg?e=lXACY4" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">WooParts Profit &amp; Loss Report – 2025</a>
</p><canvas id="profitChartA" class="w-full h-64"></canvas></div>
    <div><p class="mb-2"><a href="https://netorgft5128391.sharepoint.com/:f:/s/WooParts/EoxeUapprzhKqElf0c-ZIfkBfyEU9gAmQc_HZ_sGtezAag?e=hcH8HA" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">AutoApex Profit &amp; Loss Report – 2025</a></p><canvas id="profitChartB" class="w-full h-64"></canvas></div>
    </div>
  `;

  ['WooParts', 'AutoApex'].forEach((tab, idx) => {
    fetch(makeUrl(tab))
      .then(r => r.text())
      .then(raw => {
        const json = JSON.parse(raw.substr(47).slice(0, -2));
        console.log(`${tab} rows:`, json.table.rows.length);
        const rows    = json.table.rows;
        const labels  = rows.map(r => r.c[0]?.v);
        const profits = rows.map(r => r.c[1]?.v);
        const margins = rows.map(r => r.c[2]?.v);
        const ctx     = document
                        .getElementById(idx === 0 ? 'profitChartA' : 'profitChartB')
                        .getContext('2d');

      const myChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels,
    datasets: [
      { label: 'Net Profit',       data: profits,  backgroundColor: 'rgba(54,162,235,0.5)' },
      { label: 'Net Profit Margin %', data: margins, backgroundColor: 'rgba(255,159,64,0.5)', yAxisID: 'marginAxis' }
    ]
  },
options: {
  responsive: true,
  scales: {
    x: {
      title: { display: true, text: 'Week Numbers' }
    },
    y: {
      beginAtZero: true,
      title: { display: true, text: 'Net Profit' }
    },
    marginAxis: {
      beginAtZero: true,
      position: 'right',
      grid: { drawOnChartArea: false },
      title: { display: true, text: 'Net Profit Margin %' },
      ticks: {
        callback: v => (v * 100).toFixed(2) + '%'
      }
    }
  },
  plugins: {
    tooltip: {
      callbacks: {
        label: ctx =>
          ctx.dataset.label === 'Margin (%)'
            ? (ctx.parsed.y * 100).toFixed(2) + '%'
            : ctx.parsed.y.toFixed(2)
      }
    },
    legend: {
      
        onClick(e, legendItem, legend) {
          Chart.defaults.plugins.legend.onClick.call(this.chart, e, legendItem, legend);
          const ds = this.chart.data.datasets[legendItem.datasetIndex];
          if (ds.yAxisID === 'marginAxis') {
            this.chart.options.scales.marginAxis.title.text = 'Net Profit Margin %';
          } else {
            this.chart.options.scales.y.title.text = 'Net Profit';
          }
          this.chart.update();
        }
      }
    }
  }
});
      })
      .catch(err => console.error(`Error loading ${tab}:`, err));
  });

  return;
}

    try {
      const data = await fetchItems(slug),
            groups = Array.isArray(data) ? { '': data } : data;
      for (const [cat, items] of Object.entries(groups)) {
        if (cat) {
          const h = document.createElement('h3');
          h.className = 'text-lg font-semibold mt-4';
          h.textContent = cat;
          detailList.appendChild(h);
        }
        items.forEach(i => {
          const li = document.createElement('li'),
                btn = document.createElement('button');
          btn.className = 'flex items-center text-indigo-600 hover:underline focus:outline-none';
          btn.textContent = i.name;
          const id = i.id || i.name,
                dot = document.createElement('span');
          dot.className = 'ml-2 inline-block w-2 h-2 bg-red-600 rounded-full';
          if (isItemRead(slug, id)) dot.classList.add('hidden');
          btn.appendChild(dot);
          btn.onclick = () => {
            openEmailOverlay(i.name, i.content, slug);
            markItemRead(slug, id);
            dot.classList.add('hidden');
            if (!hasUnreadForSlug(slug)) {
              const b = document.querySelector(`[data-slug="${slug}"] .badge`);
              b && b.classList.add('hidden');
            }
          };
          li.appendChild(btn);
          detailList.appendChild(li);
        });
      }
    } catch {
      detailList.innerHTML = '<li class="text-red-500">This page is under construction – check back soon!</li>';
    }
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Tab' && !overlay.classList.contains('hidden')) {
      const focusable = Array.from(overlayDialog.querySelectorAll('button,[href],input,textarea,[tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled),
            idx = focusable.indexOf(document.activeElement);
      if (e.shiftKey && idx === 0) { focusable[focusable.length-1].focus(); e.preventDefault(); }
      else if (!e.shiftKey && idx === focusable.length-1) { focusable[0].focus(); e.preventDefault(); }
    }
  });

  let lastFocused;
  function openEmailOverlay(name, html, slug) {
    lastFocused = document.activeElement;
    document.documentElement.style.overflow = '';
    overlayHeader.textContent = name;
    const c = cardsData.find(x => x.slug === slug);
    overlayBody.innerHTML = `${c ? `<h3 class="text-lg font-semibold mb-2">${c.title}</h3>` : ''}<div class="prose max-w-none space-y-4">${html}</div>`;
    addToRecents({ id: name, slug, title: name, content: html, type: 'item' });
    overlay.classList.remove('hidden');
    overlayDialog.classList.add('opacity-100','scale-100');
    copyBtn.classList.remove('hidden');
    overlayClose.focus();
  }
  overlayClose.onclick = () => {
    overlay.classList.add('hidden');
    overlayDialog.classList.remove('opacity-100','scale-100');
    document.documentElement.style.overflow = '';
    lastFocused && lastFocused.focus();
  };
  overlay.onclick = e => { if (e.target === overlay) overlayClose.click(); };
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(overlayBody.innerText).then(() => {
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy', 2000);
    });
  };

  backBtn.onclick = () => {
    detailContainer.classList.add('hidden');
    container.classList.remove('hidden');
    document.documentElement.style.overflow = '';
  };
  window.addEventListener('scroll', () => { toTopBtn.classList.toggle('hidden', window.scrollY < 300); });
  toTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

  function iconFor(t) { return { updates:'🔔','email-templates':'✉️',processes:'🛠️',reports:'📊',links:'🔗',tutorials:'🎥',directory:'📇' }[t] || '🆕'; }
  function getRelativeTime(d) {
    const diff = (new Date() - d) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff/60)} min${Math.floor(diff/60)>1?'s':''} ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)} hour${Math.floor(diff/3600)>1?'s':''} ago`;
    return d.toLocaleDateString();
  }

const NKEY='notifications',SKEY='seenNotifIds',
      ls=k=>JSON.parse(localStorage.getItem(k)||'[]'),
      st=(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
      seen=new Set(ls(SKEY)),
      setCount=n=>{
        const e=document.getElementById('notification-count');
        n?e.classList.remove('hidden'):e.classList.add('hidden');
        e.textContent=n;
      };

async function pollNotifications(){
  let nots=ls(NKEY);
  try{
    let r=await fetch('data/notification.json');
    if(r.ok) for(let u of await r.json()){
      let id=u.id||u.timestamp+u.text;
      if(!nots.some(x=>x.id===id))
        nots.unshift({id,text:u.text,time:new Date().toISOString(),type:'updates'});
    }
  }catch{}
  for(let c of cardsData){
    if(c.slug==='reports') continue;
    try{
      let r=await fetch(`data/${c.slug}.json`);
      if(r.ok){
        let arr=Array.isArray(await r.json())
          ? await r.json()
          : Object.values(await r.json()).flat();
        for(let i of arr){
          let id=`${c.slug}|${i.name}`;
          if(!nots.some(x=>x.id===id))
            nots.unshift({id,text:`New ${c.title}: ${i.name}`,time:new Date().toISOString(),type:c.slug});
        }
      }
    }catch{}
  }
  st(NKEY,nots);
  const unread=nots.filter(x=>!seen.has(x.id)),
        all=[...unread,...nots.filter(x=>seen.has(x.id))],
        ul=document.getElementById('notification-list');
  ul.innerHTML='';
  for(let i of all){
    let li=document.createElement('li'),
        wr=document.createElement('div'),
        tm=document.createElement('time');
    if(!seen.has(i.id)){
      let b=document.createElement('span');
      b.textContent='New '; b.className='new-badge text-red-600 text-xs font-semibold mr-1';
      wr.appendChild(b);
    }
    wr.appendChild(Object.assign(document.createElement('span'),{textContent:`🔔 ${i.text}`}));
    let d=new Date(i.time);
    tm.textContent=d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit',hour12:true});
    tm.title=d.toLocaleString();
    li.className='p-2 border-b hover:bg-gray-50 flex justify-between items-center';
    li.append(wr,tm);
    ul.appendChild(li);
  }
  st(SKEY,[...seen]);
  setCount(unread.length);
  updateCardBadges();
}

setInterval(pollNotifications,60000);
pollNotifications();

document.getElementById('notification-btn').onclick=e=>{
  const dd=document.getElementById('notification-dropdown'),
        open=!dd.classList.toggle('hidden');
  e.currentTarget.setAttribute('aria-expanded',open);
  if(open){
    ls(NKEY).forEach(n=>seen.add(n.id));
    st(SKEY,[...seen]);
    setCount(0);
    document.querySelectorAll('#notification-list .new-badge').forEach(b=>b.remove());
  }
};

document.getElementById('clear-notifications').onclick=_=>{
  ls(NKEY).forEach(n=>seen.add(n.id));
  st(SKEY,[...seen]);
  document.getElementById('notification-list').innerHTML='';
  setCount(0);
};

  let allUpdates = [], displayCount=5, initialUpdatesLoad=true;
  async function pollUpdatesPanel() {
    try {
      const r = await fetch('data/updates.json');
      if (r.ok) {
        const j = await r.json();
        allUpdates = j.map(u => ({ text:u.text, time:u.timestamp, link:u.link }));
        renderUpdatesPanel();
      }
    } catch {}
  }
  function renderUpdatesPanel() {
    const fv = (updatesFilter?.value || mobileUpdatesFilter?.value || '').toLowerCase();
    const fl = allUpdates.filter(u => u.text.toLowerCase().includes(fv))
                         .sort((a,b)=>new Date(b.time)-new Date(a.time));
    const ts = fl.slice(0, displayCount), lastSeen = localStorage.getItem('lastSeenUpdate'),
          latestTime = ts[0]?.time, isNew = latestTime && latestTime !== lastSeen;
    [updatesContainer, mobileUpdatesContainer].forEach(cn => {
      cn.innerHTML = '';
      if (!ts.length) {
        const li = document.createElement('li');
        li.textContent = 'No updates available.'; li.className='py-2 text-gray-500';
        cn.appendChild(li);
      } else ts.forEach((u,i) => {
        const li = document.createElement('li');
        if (u.link) {
          const a = document.createElement('a');
          a.href = u.link; a.className = 'block py-2 hover:underline';
          if (i===0 && initialUpdatesLoad) {
            const b = document.createElement('span');
            b.textContent='New '; b.className='text-red-600 text-xs font-semibold';
            a.appendChild(b);
            document.getElementById('update-banner').classList.remove('hidden');
            document.getElementById('update-banner').classList.add('show');
            document.getElementById('update-banner-content').textContent = u.text;
          }
          a.appendChild(document.createTextNode(`${u.time}: ${u.text}`));
          li.appendChild(a);
        } else {
          if (i===0 && initialUpdatesLoad) {
            const b = document.createElement('span');
            b.textContent='New '; b.className='text-red-600 text-xs font-semibold';
            li.appendChild(b);
            document.getElementById('update-banner').classList.remove('hidden');
            document.getElementById('update-banner').classList.add('show');
            document.getElementById('update-banner-content').textContent = u.text;
          }
          li.appendChild(document.createTextNode(`${u.time}: ${u.text}`));
          li.className='py-2';
        }
        cn.appendChild(li);
      });
    });
    if (isNew) localStorage.setItem('lastSeenUpdate', latestTime);
    initialUpdatesLoad=false;
  }
  setInterval(pollUpdatesPanel, 60000);
  pollUpdatesPanel();
  updatesFilterToggle.onclick = () => updatesFilterContainer.classList.toggle('hidden');

  const changelogFilterToggle    = document.getElementById('changelog-filter-toggle'),
      changelogFilterContainer = document.getElementById('changelog-filter-container'),
      changelogFilter          = document.getElementById('changelog-filter');
changelogFilterToggle.addEventListener('click', () =>
  changelogFilterContainer.classList.toggle('hidden')
);
changelogFilter.addEventListener('input', debounce(renderChangeLog, 200));

function renderChangeLog() {
  const fv = changelogFilter.value.toLowerCase();
  const entries = loadCL();  // your helper that reads localStorage/history.json
  const filtered = entries.filter(e =>
    e.message.toLowerCase().includes(fv)
  );
  const listHtml = filtered.length
    ? filtered.map(e => `<li class="py-2">${e.timestamp}: ${e.message}</li>`).join('')
    : '<li class="py-2 text-gray-500">No matching updates.</li>';
  document.getElementById('change-log').innerHTML = listHtml;
}
  mobileUpdatesFilterToggle.onclick = () => mobileUpdatesFilterContainer.classList.toggle('hidden');
  updatesFilter?.addEventListener('input', debounce(renderUpdatesPanel,200));
  mobileUpdatesFilter?.addEventListener('input', debounce(renderUpdatesPanel,200));

  let fuse;
  async function buildSearchIndex() {
    const items = cardsData.map(c=>({name:c.title,content:c.description,slug:c.slug,isRoot:true}));
    for (const c of cardsData) if (c.slug!=='reports') {
      try {
        const d = await fetchItems(c.slug);
        const arr = Array.isArray(d)?d:Object.values(d).flat();
        arr.forEach(i=>items.push({name:i.name,content:i.content,slug:c.slug,isRoot:false}));
      } catch {}
    }
    fuse = new Fuse(items,{keys:['name','content'],includeMatches:true,threshold:0.4});
  }
  function renderSuggestions(results) {
    searchSuggestions.innerHTML = '';
    if (!results.length) {
      searchSuggestions.innerHTML = '<li class="px-4 py-2 text-gray-500">No results</li>';
    } else results.forEach(r => {
      let label = r.item.name;
      const m = r.matches.find(x=>x.key==='name');
      if (m) {
        let h='', last=0;
        m.indices.forEach(([s,e])=>{ h+=label.slice(last,s)+`<mark>${label.slice(s,e+1)}</mark>`; last=e+1; });
        h+=label.slice(last); label=h;
      }
      const li = document.createElement('li');
      li.role='option'; li.className='px-4 py-2 hover:bg-gray-100 cursor-pointer';
      li.innerHTML=label;
      li.onclick = () => {
        (r.item.isRoot?showContent:openEmailOverlay)(r.item.slug||r.item.name,r.item.content,r.item.slug);
        searchSuggestions.classList.add('hidden');
        searchInput.setAttribute('aria-expanded','false');
      };
      searchSuggestions.appendChild(li);
    });
  }
  searchInput.addEventListener('input', debounce(async e=>{
    const q = e.target.value.trim();
    if (!q) return searchSuggestions.classList.add('hidden');
    if (!fuse) await buildSearchIndex();
    renderSuggestions(fuse.search(q));
    searchSuggestions.classList.remove('hidden');
    searchInput.setAttribute('aria-expanded','true');
  },250));
  document.addEventListener('keydown', e => {
    if (e.key==='/' && document.activeElement!==searchInput) {
      e.preventDefault();
      searchInput.focus();
    }
  });

document.addEventListener("DOMContentLoaded", async () => {
  const key = "changeLogEntries";
  let entries = [];
  try {
    const r = await fetch(`data/history.json?cb=${Date.now()}`, { cache: "no-store" });
    if (r.ok) entries = await r.json();
  } catch {}
  if (!entries.length) entries = JSON.parse(localStorage.getItem(key) || "[]");
  localStorage.setItem(key, JSON.stringify(entries));
  document.getElementById("change-log").innerHTML = entries.length
    ? entries.map(e => `<li class="py-2">${e.timestamp}: ${e.message}</li>`).join("")
    : '<li class="py-2 text-gray-500">No updates available.</li>';
  renderRecentlyViewed(JSON.parse(localStorage.getItem("recentlyViewed") || "[]"));
  renderCards();
  buildSearchIndex();
});
  const banner       = document.getElementById('update-banner');
  const bannerClose  = document.getElementById('update-banner-close');

  bannerClose.addEventListener('click', () => {
    banner.classList.remove('show');
    banner.classList.add('hidden');
});  
  new EventSource('/updates').onmessage = e => {
    const update = JSON.parse(e.data);
    const entries = JSON.parse(localStorage.getItem('changeLogEntries') || '[]');
    entries.unshift(update);
    localStorage.setItem('changeLogEntries', JSON.stringify(entries));
    document.getElementById('change-log').innerHTML = entries.map(e =>
      `<div class="update-item">${e.timestamp}: ${e.message}</div>`
    ).join('');
  };

</script>
</body>
</html>
